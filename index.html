<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Market Explorer (Polymarket & Myriad)</title>
<style>
  body { font-family: system-ui, Arial, sans-serif; margin: 16px; }
  h1 { margin: 0 0 12px; }
  .controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
  input,button,select { padding:6px 8px; font-size:14px; }
  table { width:100%; border-collapse: collapse; }
  th,td { border-bottom:1px solid #ddd; padding:8px; text-align:left; vertical-align:top; }
  .muted{ opacity:.7; font-size:12px; }
  .token{ display:inline-block; font-family:ui-monospace,Menlo,monospace; font-size:12px; background:#f5f5f5; padding:2px 6px; border-radius:6px; margin:2px 4px 2px 0; }
  .chip{ display:inline-block; padding:2px 6px; border-radius:999px; background:#e8f8e8; font-size:12px; margin-left:6px; }
  .ladder{ display:grid; grid-template-columns:120px 120px; gap:10px; margin-top:6px; }
  .mini { font-size:12px; width:100%; border-collapse: collapse; margin-top:4px; }
  .mini th,.mini td{ border-bottom:1px dashed #eee; padding:4px 6px; }
  details { margin-top:6px; }
  .nowrap{ white-space:nowrap; }
</style>
</head>
<body>
<h1>Market Explorer <span class="muted">(Polymarket & Myriad)</span></h1>

<div class="controls">
  <label>Source:
    <select id="source">
      <option value="poly" selected>Polymarket</option>
      <option value="myriad">Myriad (Polkamarkets)</option>
    </select>
  </label>
  <label>Filter: <input id="q" placeholder="type to filter by question/slug/title" /></label>
  <label>Page size:
    <select id="pageSize"><option>25</option><option>50</option><option selected>100</option><option>200</option></select>
  </label>
  <button id="refreshBtn">Refresh</button>
  <span id="status" class="muted"></span>
</div>

<table>
  <thead><tr><th>Question / Title</th><th class="nowrap">Market ID</th><th>Tokens / Prices</th></tr></thead>
  <tbody id="tbody"></tbody>
</table>

<div class="controls">
  <button id="prevBtn">← Prev</button>
  <span id="pageInfo" class="muted"></span>
  <button id="nextBtn">Next →</button>
</div>

<script>
// ---------- Config
const PROXY = "https://arbarbarb.rihardschnr2.workers.dev/"; // your Cloudflare Worker
const GAMMA = "https://gamma-api.polymarket.com";
const CLOB  = "https://clob.polymarket.com";
const MYRIAD_BASE   = "https://api-production.polkamarkets.com/markets";
const MYRIAD_PARAMS = "network_id=274133&state=open&land_ids=myriad-szn2-usdc-v33&per_page=100";

// ---------- Proxy fetch (uses your Worker) with cache-bust + gentle 429 backoff
async function xfetch(url,{retries=4,backoff=500}={}){
  const bust=`_=${Date.now()}`;
  const proxied = `${PROXY}?url=${encodeURIComponent(url)}&${bust}`;
  for(let a=0;a<retries;a++){
    const r = await fetch(proxied, { method:"GET", cache:"no-store" });
    if(r.status===429){ await new Promise(res=>setTimeout(res, backoff*(2**a))); continue; }
    if(!r.ok) throw new Error(`Proxy HTTP ${r.status} for ${url}`);
    const ct = r.headers.get("content-type")||"";
    return ct.includes("application/json") ? r.json() : r.text();
  }
  throw new Error(`Retry limit reached for ${url}`);
}

// ---------- State
let RAW=[], VIEW=[], BY_ID={}, page=0;
const sourceEl=document.getElementById('source');
const qEl=document.getElementById('q');
const pageSizeEl=document.getElementById('pageSize');
const statusEl=document.getElementById('status');
const tbody=document.getElementById('tbody');
const pageInfo=document.getElementById('pageInfo');

// ---------- UI wiring
document.getElementById('refreshBtn').onclick = load; // ONLY fetch when Refresh is clicked
document.getElementById('prevBtn').onclick = () => { if (page>0){ page--; render(); } };
document.getElementById('nextBtn').onclick = () => { if ((page+1)*pageSize() < VIEW.length){ page++; render(); } };
qEl.oninput = applyFilter;
pageSizeEl.onchange = () => { page=0; render(); };
sourceEl.onchange = () => setStatus(`Source set to ${sourceEl.value === 'poly' ? 'Polymarket' : 'Myriad'} — press Refresh to load.`);

// ---------- Utils
function pageSize(){ return parseInt(pageSizeEl.value,10)||100; }
function parseIso(s){ const d=s?new Date(s):null; return isFinite(d)?d:null; }
function escapeHtml(s){ return (s||"").replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function setStatus(s){ statusEl.textContent=s; }
function today(){ const d=new Date(); d.setHours(0,0,0,0); return d; }
const nf = (x,dp=2)=> (x==null?'—':Number(x).toLocaleString(undefined,{maximumFractionDigits:dp}));
const pf = (x,dp=2)=> (x==null?'—':Number(x).toFixed(dp));

// ---------- Polymarket loaders (via Worker)
async function fetchAllClobMarkets(){
  let cursor=""; const out=[];
  while(true){
    const url=`${CLOB}/markets${cursor?`?next_cursor=${encodeURIComponent(cursor)}`:""}`;
    const data = await xfetch(url);
    const arr = data?.data || [];
    out.push(...arr);
    cursor = data?.next_cursor;
    setStatus(`Polymarket CLOB: ${out.length} markets loaded…`);
    if(!cursor || cursor==="LTE=") break;
    await new Promise(r=>setTimeout(r,200));
  }
  return out;
}
async function fetchAllGammaOpen(){
  const limit=1000; let offset=0; const out=[];
  while(true){
    const url=`${GAMMA}/markets?closed=false&limit=${limit}&offset=${offset}`;
    const chunk = await xfetch(url);
    if(!Array.isArray(chunk)||chunk.length===0) break;
    out.push(...chunk);
    offset+=chunk.length;
    setStatus(`Polymarket Gamma: ${out.length} open markets loaded…`);
    if(chunk.length<limit) break;
    await new Promise(r=>setTimeout(r,50));
  }
  return out;
}
async function loadPolymarket(){
  const [clob,gamma]=await Promise.all([fetchAllClobMarkets(), fetchAllGammaOpen()]);
  const byCond=new Map();
  for(const m of clob){
    const k=(m.conditionId||m.condition_id||m.condition_hash||"").toLowerCase();
    if(k) byCond.set(k,m);
  }
  const now=today();
  RAW = gamma
    .filter(g => { const end=parseIso(g.endDateIso||g.endDate); return !end || end >= now; })
    .map(g=>{
      const condKey=String(g.conditionId||g.questionID||"").toLowerCase();
      const cm=byCond.get(condKey)||{};
      return {
        src:"poly",
        id:g.id, question:g.question, slug:g.slug,
        endDateIso:g.endDateIso||g.endDate,
        active:g.active, closed:g.closed,
        outcomes:g.outcomes, clobTokenIds:g.clobTokenIds,
        bestBid:g.bestBid, bestAsk:g.bestAsk,
        clob:cm
      };
    })
    .sort((a,b)=>{
      const ea=parseIso(a.endDateIso)?.getTime()??Infinity;
      const eb=parseIso(b.endDateIso)?.getTime()??Infinity;
      return ea-eb;
    });
  BY_ID = Object.fromEntries(RAW.map(m=>[String(m.id), m]));
  setStatus(`Polymarket: ${RAW.length} open, unexpired markets.`);
  applyFilter();
}

// ---------- Myriad loader (via Worker) — adds outcomes
async function loadMyriad(){
  const now = today();
  const perPage = 100;
  let pageNum = 1;
  const all = [];

  try {
    while (true) {
      const url = `${MYRIAD_BASE}?${MYRIAD_PARAMS}&page=${pageNum}`;
      const resp = await xfetch(url);
      const chunk = Array.isArray(resp) ? resp : (Array.isArray(resp?.data) ? resp.data : []);
      setStatus(`Myriad: page ${pageNum} → ${chunk.length} markets`);
      if (!chunk.length) break;
      all.push(...chunk);
      if (chunk.length < perPage) break;
      pageNum++;
      await new Promise(r => setTimeout(r, 80));
    }
  } catch (e) {
    console.error("Myriad fetch via Worker failed:", e);
    setStatus(`Myriad fetch via Worker failed: ${e?.message || e}`);
    return;
  }

  RAW = all
    .filter(m => m?.state === "open")
    .filter(m => { const end = parseIso(m.expires_at); return !end || end >= now; })
    .map(m => ({
      src: "myriad",
      id: m.id, question: m.title, slug: m.slug,
      endDateIso: m.expires_at,
      active: true, closed: false,
      liquidity: m.liquidity, volume: m.volume, volume24h: m.volume_24h,
      users: m.users, tokenSymbol: m?.token?.symbol || "",
      resolution_source: m.resolution_source || "",
      outcomes: Array.isArray(m.outcomes) ? m.outcomes : [],
      raw: m
    }))
    .sort((a,b)=>{
      const ea = parseIso(a.endDateIso)?.getTime() ?? Infinity;
      const eb = parseIso(b.endDateIso)?.getTime() ?? Infinity;
      return ea - eb;
    });

  BY_ID = Object.fromEntries(RAW.map(m => [String(m.id), m]));
  setStatus(`Myriad: ${RAW.length} open, unexpired markets.`);
  applyFilter();
}

// ---------- Master loader (manual only)
async function load(){
  setStatus("Loading…");
  try{
    if(sourceEl.value==="poly"){ await loadPolymarket(); }
    else { await loadMyriad(); }
  }catch(e){
    console.error(e);
    setStatus(`Failed to load: ${e?.message||e}`);
  }
}

// ---------- Filter + render
function applyFilter(){
  const q=(qEl.value||"").toLowerCase();
  VIEW = RAW.filter(m => (`${m.question} ${m.slug}`.toLowerCase()).includes(q));
  page=0; render();
}
function render(){
  tbody.innerHTML="";
  const ps=pageSize();
  const slice=VIEW.slice(page*ps,page*ps+ps);

  for(const m of slice){
    const tr=document.createElement('tr');

    const tdQ=document.createElement('td');
    const end=parseIso(m.endDateIso);
    const endTxt=end?new Intl.DateTimeFormat(undefined,{year:'numeric',month:'short',day:'numeric'}).format(end):'';
    const chip=`<span class="chip">${m.src==="poly"?"Polymarket":"Myriad"}</span>`;
    tdQ.innerHTML=`<div>${escapeHtml(m.question)} ${chip}</div>
                   <div class="muted">${escapeHtml(m.slug||'')} ${endTxt?` · ends ${endTxt}`:''}</div>`;
    tr.appendChild(tdQ);

    const tdId=document.createElement('td'); tdId.textContent=m.id; tr.appendChild(tdId);

    const tdTok=document.createElement('td');
    if(m.src==="poly"){
      tdTok.innerHTML = `
        <div class="muted">Best: ${m.bestBid!=null?pf(m.bestBid):'—'} / ${m.bestAsk!=null?pf(m.bestAsk):'—'}</div>
        <div style="margin-top:6px;">
          <button data-load-tokens="${m.id}">Load options</button>
          <button data-view-json="${m.id}">View JSON</button>
        </div>
        <div id="tokens-${m.id}" class="muted" style="margin-top:6px;">—</div>
        <div id="json-${m.id}" class="muted" style="margin-top:6px; display:none;"></div>
      `;
    } else {
      const liq = nf(m.liquidity);
      const vol = nf(m.volume);
      const vol24 = nf(m.volume24h);
      const users = m.users!=null ? Number(m.users).toLocaleString() : '—';
      tdTok.innerHTML = `
        <div class="muted">Token: ${escapeHtml(m.tokenSymbol||'—')} · Users: ${users}</div>
        <div class="muted">Liquidity: ${liq} · 24h Vol: ${vol24} · Total Vol: ${vol}</div>
        <div style="margin-top:6px;">
          ${m.resolution_source ? `<a href="${m.resolution_source}" target="_blank" rel="noopener">Resolution source ↗</a>` : ''}
          <button data-myriad-options="${m.id}" style="margin-left:8px;">Load options</button>
          <button data-view-json="${m.id}" style="margin-left:8px;">View JSON</button>
        </div>
        <div id="mopts-${m.id}" class="muted" style="margin-top:6px;">—</div>
        <div id="json-${m.id}" class="muted" style="margin-top:6px; display:none;"></div>
      `;
    }
    tr.appendChild(tdTok);
    tbody.appendChild(tr);
  }

  pageInfo.textContent = `Page ${VIEW.length ? page+1 : 0} of ${Math.ceil(VIEW.length/ps)} — ${VIEW.length} shown`;

  // Wire buttons
  tbody.querySelectorAll('button[data-load-tokens]').forEach(btn=>{
    btn.onclick = () => loadPolyTokens(btn.getAttribute('data-load-tokens'));
  });
  tbody.querySelectorAll('button[data-myriad-options]').forEach(btn=>{
    btn.onclick = () => loadMyriadOptions(btn.getAttribute('data-myriad-options'));
  });
  tbody.querySelectorAll('button[data-view-json]').forEach(btn=>{
    btn.onclick = () => toggleJson(btn.getAttribute('data-view-json'));
  });
}

// ---------- Polymarket tokens + order book (via Worker)
async function loadPolyTokens(marketId){
  const host=document.getElementById(`tokens-${marketId}`);
  if(!host) return;
  host.textContent="Loading options…";
  const meta=BY_ID[String(marketId)]||{};
  try{
    let tokens=[], detail=null;
    try{ detail=await xfetch(`${CLOB}/markets/${marketId}`);}catch(_){}
    if(detail && Array.isArray(detail.tokens) && detail.tokens.length){
      tokens=detail.tokens.map(t=>({id:t.id||t.token_id,label:t.name||t.label||t.ticker||t.outcome||'Outcome'}));
    }else{
      const ids=typeof meta.clobTokenIds==='string'?JSON.parse(meta.clobTokenIds):(meta.clobTokenIds||[]);
      const outs=typeof meta.outcomes==='string'?JSON.parse(meta.outcomes):(meta.outcomes||[]);
      tokens=ids.map((tid,i)=>({id:String(tid),label:String(outs[i]??`Outcome ${i+1}`)}));
    }
    if(!tokens.length){ host.textContent="No tokens found for this market."; return; }

    const tbl=document.createElement('table'); tbl.className='mini';
    tbl.innerHTML=`<thead><tr><th>Outcome</th><th>Token</th><th>Best bid</th><th>Best ask</th><th></th></tr></thead><tbody></tbody>`;
    const body=tbl.querySelector('tbody');

    for(const t of tokens){
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${escapeHtml(t.label)}</td>
        <td><span class="token">${t.id}</span></td>
        <td id="bb-${t.id}" class="muted">…</td>
        <td id="ba-${t.id}" class="muted">…</td>
        <td><button data-view-book="${t.id}">View book</button></td>`;
      body.appendChild(tr);

      xfetch(`${CLOB}/book?token_id=${encodeURIComponent(t.id)}`).then(book=>{
        document.getElementById(`bb-${t.id}`).textContent = book?.bids?.[0]?.price?.toFixed(4) ?? '—';
        document.getElementById(`ba-${t.id}`).textContent = book?.asks?.[0]?.price?.toFixed(4) ?? '—';
      }).catch(_=>{
        document.getElementById(`bb-${t.id}`).textContent='—';
        document.getElementById(`ba-${t.id}`).textContent='—';
      });
    }
    host.innerHTML=""; host.appendChild(tbl);
    host.querySelectorAll('button[data-view-book]').forEach(btn=>{
      btn.onclick=()=>viewBook(btn.getAttribute('data-view-book'),host);
    });
  }catch(e){ console.error(e); host.textContent="Failed to load options for this market."; }
}

async function viewBook(tokenId, host){
  let existing=document.getElementById(`bookwrap-${tokenId}`);
  if(existing){ existing.open=!existing.open; return; }
  const det=document.createElement('details'); det.id=`bookwrap-${tokenId}`; det.open=true;
  det.innerHTML=`<summary>Order book for ${tokenId}</summary><div id="book-${tokenId}" class="ladder">Loading…</div>`;
  host.appendChild(det);
  try{
    const book=await xfetch(`${CLOB}/book?token_id=${encodeURIComponent(tokenId)}`);
    const bids=(book?.bids||[]).slice(0,15).map(b=>`${Number(b.price).toFixed(4)} @ ${Number(b.size).toFixed(4)}`).join('<br/>')||'—';
    const asks=(book?.asks||[]).slice(0,15).map(a=>`${Number(a.price).toFixed(4)} @ ${Number(a.size).toFixed(4)}`).join('<br/>')||'—';
    document.getElementById(`book-${tokenId}`).innerHTML = `<div><b>Bids (top 15)</b><br/>${bids}</div><div><b>Asks (top 15)</b><br/>${asks}</div>`;
  }catch(e){ console.error(e); document.getElementById(`book-${tokenId}`).textContent="Failed to load book."; }
}

// ---------- Myriad options (price + shares + holders)
async function loadMyriadOptions(marketId){
  const host = document.getElementById(`mopts-${marketId}`);
  if(!host) return;
  host.textContent = "Loading options…";

  try {
    let m = BY_ID[String(marketId)];
    let outcomes = Array.isArray(m?.outcomes) ? m.outcomes : [];

    // Fallback: fetch details if the list payload had no outcomes
    if (!outcomes.length) {
      const detail = await xfetch(`${MYRIAD_BASE}/${marketId}`);
      outcomes = Array.isArray(detail?.outcomes) ? detail.outcomes : [];
    }

    if (!outcomes.length) {
      host.textContent = "No options found for this market.";
      return;
    }

    const tbl = document.createElement('table');
    tbl.className = 'mini';
    tbl.innerHTML = `
      <thead><tr><th>Outcome</th><th>Price</th><th>Shares</th><th>Holders</th></tr></thead>
      <tbody></tbody>
    `;
    const body = tbl.querySelector('tbody');

    for (const o of outcomes) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(o.title || `Outcome ${o.id}`)}</td>
        <td>${pf(o.price, 6)}</td>
        <td>${nf(o.shares, 4)}</td>
        <td>${o.holders != null ? Number(o.holders).toLocaleString() : '—'}</td>
      `;
      body.appendChild(tr);
    }

    host.innerHTML = "";
    host.appendChild(tbl);
  } catch (e) {
    console.error(e);
    host.textContent = "Failed to load options for this market.";
  }
}

// ---------- JSON peek (both sources)
function toggleJson(id){
  const el=document.getElementById(`json-${id}`); if(!el) return;
  if(el.style.display==="none"){
    const m=BY_ID[String(id)];
    el.textContent = JSON.stringify(m.src==="poly"?m:m.raw, null, 2);
    el.style.display="block";
  }else{
    el.style.display="none";
  }
}

// ---------- Start message (no auto-fetch)
setStatus("Select a source, then press Refresh to load.");
</script>
</body>
</html>
