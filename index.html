<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Market Explorer (Polymarket & Myriad)</title>
<style>
  body { font-family: system-ui, Arial, sans-serif; margin: 16px; }
  h1 { margin: 0 0 12px; }
  .controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
  input,button,select { padding:6px 8px; font-size:14px; }
  table { width:100%; border-collapse: collapse; }
  th,td { border-bottom:1px solid #ddd; padding:8px; text-align:left; vertical-align:top; }
  .muted{ opacity:.7; font-size:12px; }
  .token{ display:inline-block; font-family:ui-monospace,Menlo,monospace; font-size:12px; background:#f5f5f5; padding:2px 6px; border-radius:6px; margin:2px 4px 2px 0; }
  .chip{ display:inline-block; padding:2px 6px; border-radius:999px; background:#e8f8e8; font-size:12px; margin-left:6px; }
  .ladder{ display:grid; grid-template-columns:120px 120px; gap:10px; margin-top:6px; }
  .mini { font-size:12px; width:100%; border-collapse: collapse; margin-top:4px; }
  .mini th,.mini td{ border-bottom:1px dashed #eee; padding:4px 6px; }
  details { margin-top:6px; }
  .nowrap{ white-space:nowrap; }
</style>
</head>
<body>
<h1>Market Explorer <span class="muted">(Polymarket & Myriad)</span></h1>

<div class="controls">
  <label>Source:
    <select id="source">
      <option value="poly" selected>Polymarket</option>
      <option value="myriad">Myriad (Polkamarkets)</option>
    </select>
  </label>
  <label>Filter: <input id="q" placeholder="type to filter by question/slug/title" /></label>
  <label>Page size:
    <select id="pageSize"><option>25</option><option>50</option><option selected>100</option><option>200</option></select>
  </label>
  <button id="refreshBtn">Refresh</button>
  <span id="status" class="muted"></span>
</div>

<table>
  <thead><tr><th>Question / Title</th><th class="nowrap">Market ID</th><th>Tokens / Prices</th></tr></thead>
  <tbody id="tbody"></tbody>
</table>

<div class="controls">
  <button id="prevBtn">← Prev</button>
  <span id="pageInfo" class="muted"></span>
  <button id="nextBtn">Next →</button>
</div>

<script>
// ---------- Config
const GAMMA = "https://gamma-api.polymarket.com";
const CLOB  = "https://clob.polymarket.com";
const MYRIAD_BASE   = "https://api-production.polkamarkets.com/markets";
const MYRIAD_PARAMS = "network_id=274133&state=open&land_ids=myriad-szn2-usdc-v33&per_page=100";

// ---------- State
let RAW=[], VIEW=[], BY_ID={}, page=0;
const sourceEl=document.getElementById('source');
const qEl=document.getElementById('q');
const pageSizeEl=document.getElementById('pageSize');
const statusEl=document.getElementById('status');
const tbody=document.getElementById('tbody');
const pageInfo=document.getElementById('pageInfo');

// ---------- UI wiring
document.getElementById('refreshBtn').onclick = load; // ONLY fetch when Refresh is clicked
document.getElementById('prevBtn').onclick = () => { if (page>0){ page--; render(); } };
document.getElementById('nextBtn').onclick = () => { if ((page+1)*pageSize() < VIEW.length){ page++; render(); } };
qEl.oninput = applyFilter;
pageSizeEl.onchange = () => { page=0; render(); };
sourceEl.onchange = () => {
  setStatus(`Source set to ${sourceEl.value === 'poly' ? 'Polymarket' : 'Myriad'} — press Refresh to load.`);
};

// ---------- Utils
function pageSize(){ return parseInt(pageSizeEl.value,10)||100; }
function parseIso(s){ const d=s?new Date(s):null; return isFinite(d)?d:null; }
function escapeHtml(s){ return (s||"").replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function setStatus(s){ statusEl.textContent=s; }
function today(){ const d=new Date(); d.setHours(0,0,0,0); return d; }

// ---------- Polymarket loaders
async function fetchAllClobMarkets(){
  let cursor=""; const out=[];
  while(true){
    const url=`${CLOB}/markets${cursor?`?next_cursor=${encodeURIComponent(cursor)}`:""}`;
    const r=await fetch(url);
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    const data=await r.json();
    const arr=data?.data||[];
    out.push(...arr);
    cursor=data?.next_cursor;
    setStatus(`Polymarket CLOB: ${out.length} markets loaded…`);
    if(!cursor||cursor==="LTE=") break;
    await new Promise(r=>setTimeout(r,200));
  }
  return out;
}
async function fetchAllGammaOpen(){
  const limit=1000; let offset=0; const out=[];
  while(true){
    const url=`${GAMMA}/markets?closed=false&limit=${limit}&offset=${offset}`;
    const r=await fetch(url);
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    const chunk=await r.json();
    if(!Array.isArray(chunk)||chunk.length===0) break;
    out.push(...chunk);
    offset+=chunk.length;
    setStatus(`Polymarket Gamma: ${out.length} open markets loaded…`);
    if(chunk.length<limit) break;
    await new Promise(r=>setTimeout(r,50));
  }
  return out;
}
async function loadPolymarket(){
  const [clob,gamma]=await Promise.all([fetchAllClobMarkets(), fetchAllGammaOpen()]);
  const byCond=new Map();
  for(const m of clob){
    const k=(m.conditionId||m.condition_id||m.condition_hash||"").toLowerCase();
    if(k) byCond.set(k,m);
  }
  const now=today();
  RAW = gamma
    .filter(g => { const end=parseIso(g.endDateIso||g.endDate); return !end || end >= now; })
    .map(g=>{
      const condKey=String(g.conditionId||g.questionID||"").toLowerCase();
      const cm=byCond.get(condKey)||{};
      return {
        src:"poly",
        id:g.id, question:g.question, slug:g.slug,
        endDateIso:g.endDateIso||g.endDate,
        active:g.active, closed:g.closed,
        outcomes:g.outcomes, clobTokenIds:g.clobTokenIds,
        bestBid:g.bestBid, bestAsk:g.bestAsk,
        clob:cm
      };
    })
    .sort((a,b)=>{
      const ea=parseIso(a.endDateIso)?.getTime()??Infinity;
      const eb=parseIso(b.endDateIso)?.getTime()??Infinity;
      return ea-eb;
    });
  BY_ID = Object.fromEntries(RAW.map(m=>[String(m.id), m]));
  setStatus(`Polymarket: ${RAW.length} open, unexpired markets.`);
  applyFilter();
}

// ---------- Myriad loader (direct fetch, no Worker)
async function fetchDirectJson(url) {
  const r = await fetch(url, {mode:"cors",cache:"no-store",headers:{"Accept":"application/json"}});
  if(!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}
async function loadMyriad(){
  const now=today();
  const perPage=100;
  let pageNum=1;
  const all=[];

  try {
    while(true){
      const url=`${MYRIAD_BASE}?${MYRIAD_PARAMS}&page=${pageNum}`;
      const resp=await fetchDirectJson(url);
      const chunk=Array.isArray(resp)?resp:(Array.isArray(resp?.data)?resp.data:[]);
      setStatus(`Myriad: page ${pageNum} → ${chunk.length} markets`);
      if(!chunk.length) break;
      all.push(...chunk);
      if(chunk.length<perPage) break;
      pageNum++;
    }
  } catch(e) {
    if(e instanceof TypeError){
      setStatus("Myriad fetch blocked by CORS.");
    } else {
      setStatus(`Myriad fetch failed: ${e.message}`);
    }
    console.error(e);
    return;
  }

  RAW = all
    .filter(m => m?.state === "open")
    .filter(m => { const end=parseIso(m.expires_at); return !end || end >= now; })
    .map(m => ({
      src:"myriad",
      id:m.id, question:m.title, slug:m.slug,
      endDateIso:m.expires_at,
      active:true, closed:false,
      liquidity:m.liquidity, volume:m.volume, volume24h:m.volume_24h,
      users:m.users, tokenSymbol:m?.token?.symbol || "",
      resolution_source:m.resolution_source || "",
      raw:m
    }))
    .sort((a,b)=>{
      const ea=parseIso(a.endDateIso)?.getTime()??Infinity;
      const eb=parseIso(b.endDateIso)?.getTime()??Infinity;
      return ea-eb;
    });

  BY_ID = Object.fromEntries(RAW.map(m=>[String(m.id), m]));
  setStatus(`Myriad: ${RAW.length} open, unexpired markets (direct fetch).`);
  applyFilter();
}

// ---------- Master loader
async function load(){
  setStatus("Loading…");
  try {
    if(sourceEl.value==="poly"){ await loadPolymarket(); }
    else { await loadMyriad(); }
  } catch(e){
    console.error(e);
    setStatus("Failed to load.");
  }
}

// ---------- Filter + render
function applyFilter(){
  const q=(qEl.value||"").toLowerCase();
  VIEW = RAW.filter(m => (`${m.question} ${m.slug}`).toLowerCase().includes(q));
  page=0; render();
}
function render(){
  tbody.innerHTML="";
  const ps=pageSize();
  const slice=VIEW.slice(page*ps,page*ps+ps);
  for(const m of slice){
    const tr=document.createElement('tr');
    const tdQ=document.createElement('td');
    const end=parseIso(m.endDateIso);
    const endTxt=end?new Intl.DateTimeFormat(undefined,{year:'numeric',month:'short',day:'numeric'}).format(end):'';
    const chip=`<span class="chip">${m.src==="poly"?"Polymarket":"Myriad"}</span>`;
    tdQ.innerHTML=`<div>${escapeHtml(m.question)} ${chip}</div>
                   <div class="muted">${escapeHtml(m.slug||'')} ${endTxt?` · ends ${endTxt}`:''}</div>`;
    tr.appendChild(tdQ);
    const tdId=document.createElement('td'); tdId.textContent=m.id; tr.appendChild(tdId);
    const tdTok=document.createElement('td');
    if(m.src==="poly"){
      tdTok.innerHTML=`Best: ${m.bestBid!=null?m.bestBid:'—'} / ${m.bestAsk!=null?m.bestAsk:'—'}`;
    } else {
      tdTok.innerHTML=`Users: ${m.users||'—'} · Liquidity: ${m.liquidity||'—'} · Volume: ${m.volume||'—'}`;
    }
    tr.appendChild(tdTok);
    tbody.appendChild(tr);
  }
  pageInfo.textContent=`Page ${VIEW.length? page+1:0} of ${Math.ceil(VIEW.length/ps)} — ${VIEW.length} shown`;
}

// ---------- Start
setStatus("Select a source, then press Refresh to load.");
</script>
</body>
</html>
