<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Market Explorer (DB-backed)</title>
<style>
  body{font-family:system-ui,Arial,sans-serif;margin:16px;}
  h1{margin:0 0 12px;}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:12px;}
  input,button,select{padding:6px 8px;font-size:14px;}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid #ddd;padding:8px;text-align:left;vertical-align:top}
  .muted{opacity:.7;font-size:12px}
  .mini{font-size:12px;width:100%;border-collapse:collapse;margin-top:4px}
  .mini th,.mini td{border-bottom:1px dashed #eee;padding:4px 6px}
  .chip{display:inline-block;padding:2px 6px;border-radius:999px;background:#e8f8e8;font-size:12px;margin-left:6px}
  .nowrap{white-space:nowrap}
</style>
</head>
<body>
<h1>Market Explorer <span class="muted">(stored in D1)</span></h1>

<div class="controls">
  <label>Worker:
    <input id="workerBase" value="https://arbarbarb.rihardschnr2.workers.dev" style="width:360px">
  </label>
  <label>Source:
    <select id="srcSel"><option value="poly" selected>Polymarket</option><option value="myriad">Myriad</option></select>
  </label>
  <label>Filter: <input id="q" placeholder="search question/slug/title"></label>
  <label>Page size: <select id="pageSize"><option>25</option><option>50</option><option selected>100</option><option>200</option></select></label>
  <button id="loadDbBtn">Load from DB</button>
  <span id="status" class="muted"></span>
</div>

<div class="controls">
  <label class="muted">Admin token: <input id="admTok" type="password" placeholder="ADMIN_TOKEN" style="width:260px"></label>
  <button id="ingestPoly">Ingest Polymarket → D1</button>
  <button id="ingestMyriad">Ingest Myriad → D1</button>
  <span id="ingestMsg" class="muted"></span>
</div>

<table>
  <thead><tr><th>Question / Title</th><th class="nowrap">Market ID</th><th>Outcomes</th></tr></thead>
  <tbody id="tbody"></tbody>
</table>

<div class="controls">
  <button id="prevBtn">← Prev</button>
  <span id="pageInfo" class="muted"></span>
  <button id="nextBtn">Next →</button>
</div>

<hr/>
<div id="pairs-admin" style="margin-top:16px;">
  <h3>Pairs Admin <span class="muted">(Polymarket ↔ Myriad)</span></h3>
  <div class="controls">
    <label>Admin token:
      <input id="pairTok" type="password" placeholder="paste ADMIN_TOKEN" style="width:260px;">
    </label>
    <button id="pairUse">Use in this tab</button>
    <span id="pairAuthMsg" class="muted"></span>
  </div>

  <div class="controls">
    <label>Polymarket ID: <input id="pairPoly" placeholder="e.g. 516710" style="width:160px;"></label>
    <label>Myriad ID: <input id="pairMyriad" placeholder="e.g. 134" style="width:160px;"></label>
    <label>Direction:
      <select id="pairDir"><option value="same">same</option><option value="inverse">inverse</option></select>
    </label>
  </div>

  <div class="controls">
    <label>Outcome map (JSON):
      <input id="pairMap" placeholder='[{"poly":"Yes","myriad":"≥ $125K"},{"poly":"No","myriad":"≤ $105K"}]' style="width:560px;">
    </label>
    <label>Notes: <input id="pairNotes" style="width:260px;"></label>
  </div>

  <div class="controls">
    <button id="pairCreate">Create</button>
    <button id="pairUpsert">Upsert</button>
    <button id="pairDelete" style="background:#fee;border:1px solid #f99;">Delete</button>
    <button id="pairRefresh">Refresh list</button>
    <span id="pairMsg" class="muted"></span>
  </div>

  <table class="mini" style="width:100%;">
    <thead><tr><th>Polymarket</th><th>Myriad</th><th>Dir</th><th>Map</th><th>Notes</th><th>Updated</th><th></th></tr></thead>
    <tbody id="pairTable"></tbody>
  </table>
</div>

<script>
const el = id => document.getElementById(id);
const nf = (x,dp=2)=> (x==null?'—':Number(x).toLocaleString(undefined,{maximumFractionDigits:dp}));
const pf = (x,dp=6)=> (x==null?'—':Number(x).toFixed(dp));

const baseEl=el('workerBase'), srcEl=el('srcSel'), qEl=el('q'), psEl=el('pageSize'), statusEl=el('status');
const tbody=el('tbody'), pageInfo=el('pageInfo');
const loadDbBtn=el('loadDbBtn'), prevBtn=el('prevBtn'), nextBtn=el('nextBtn');

const admTok=el('admTok'), ingestPoly=el('ingestPoly'), ingestMyriad=el('ingestMyriad'), ingestMsg=el('ingestMsg');

let ALL=[], VIEW=[], page=0;

async function api(path, {method="GET", body=null, token=null}={}) {
  const url = baseEl.value.replace(/\/+$/,'') + path;
  const r = await fetch(url, {
    method,
    headers: {
      "Content-Type": "application/json",
      ...(token ? { Authorization: "Bearer "+token } : {})
    },
    body: body ? JSON.stringify(body) : undefined,
  });
  const ct = r.headers.get('content-type')||'';
  const data = ct.includes('json') ? await r.json() : await r.text();
  if (!r.ok) throw new Error((data && data.error) || r.statusText);
  return data;
}

async function loadFromDB() {
  statusEl.textContent = "Loading from D1…";
  const src = srcEl.value;
  const q = encodeURIComponent(qEl.value||"");
  const data = await api(`/markets?src=${src}&q=${q}&limit=1000&offset=0`);
  ALL = data.markets || [];
  VIEW = ALL.slice();
  page = 0;
  render();
  statusEl.textContent = `${VIEW.length} markets from D1`;
}

function applyFilter() {
  const q = (qEl.value||'').toLowerCase();
  VIEW = ALL.filter(m => (`${(m.question||'')} ${(m.slug||'')}`.toLowerCase()).includes(q));
  page = 0;
  render();
}

function render() {
  tbody.innerHTML = '';
  const ps = parseInt(psEl.value,10)||100;
  const slice = VIEW.slice(page*ps, page*ps+ps);

  for (const m of slice) {
    const tr = document.createElement('tr');
    const chip = `<span class="chip">${m.src==="poly"?"Polymarket":"Myriad"}</span>`;
    const endTxt = m.end_date ? new Intl.DateTimeFormat(undefined,{year:'numeric',month:'short',day:'numeric'}).format(new Date(m.end_date)) : '';
    tr.innerHTML = `
      <td><div>${escapeHtml(m.question||'')} ${chip}</div><div class="muted">${escapeHtml(m.slug||'')}${endTxt?` · ends ${endTxt}`:''}</div></td>
      <td>${m.id}</td>
      <td>
        <button data-outcomes="${m.src}|${m.id}">Load outcomes</button>
        <div id="oc-${m.src}-${m.id}" class="muted" style="margin-top:6px;">—</div>
      </td>`;
    tbody.appendChild(tr);
  }

  pageInfo.textContent = `Page ${VIEW.length ? page+1 : 0} of ${Math.ceil(VIEW.length/ps)} — ${VIEW.length} shown`;

  tbody.querySelectorAll('button[data-outcomes]').forEach(btn=>{
    btn.onclick = () => loadOutcomes(btn.getAttribute('data-outcomes'));
  });
}

async function loadOutcomes(key) {
  const [src,id] = key.split('|');
  const host = el(`oc-${src}-${id}`);
  if (!host) return;
  host.textContent = "Loading…";
  const data = await api(`/outcomes?src=${encodeURIComponent(src)}&market_id=${encodeURIComponent(id)}`);
  const outs = data.outcomes || [];
  if (!outs.length) { host.textContent = "No outcomes stored."; return; }

  const tbl = document.createElement('table');
  tbl.className='mini';
  tbl.innerHTML = `<thead><tr><th>Outcome</th><th>Price</th><th>Shares</th><th>Holders</th></tr></thead><tbody></tbody>`;
  const body = tbl.querySelector('tbody');
  for (const o of outs) {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(o.label||'')}</td><td>${pf(o.price,6)}</td><td>${nf(o.shares,4)}</td><td>${o.holders==null?'—':nf(o.holders,0)}</td>`;
    body.appendChild(tr);
  }
  host.innerHTML = ""; host.appendChild(tbl);
}

function escapeHtml(s){ return (s||"").replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

// paging + filter
qEl.oninput = applyFilter;
psEl.onchange = ()=>{ page=0; render(); };
prevBtn.onclick = ()=>{ if(page>0){ page--; render(); } };
nextBtn.onclick = ()=>{ const ps=parseInt(psEl.value,10)||100; if((page+1)*ps<VIEW.length){ page++; render(); } };
loadDbBtn.onclick = loadFromDB;

// admin: ingest
async function doIngest(which){
  ingestMsg.textContent = `Ingesting ${which}…`;
  try {
    const path = which==='poly'? '/admin/ingest/poly' : '/admin/ingest/myriad';
    const res = await api(path, {method:'POST', token: admTok.value.trim()});
    ingestMsg.textContent = `Done: ${JSON.stringify(res)}`;
  } catch(e) {
    ingestMsg.textContent = e.message;
  }
}
ingestPoly.onclick = ()=>doIngest('poly');
ingestMyriad.onclick = ()=>doIngest('myriad');

// ------- Pairs Admin (D1) -------
const pairTok = el('pairTok'), pairUse = el('pairUse'), pairAuthMsg = el('pairAuthMsg');
const pairPoly = el('pairPoly'), pairMyriad = el('pairMyriad'), pairDir = el('pairDir');
const pairMap = el('pairMap'), pairNotes = el('pairNotes'), pairMsg = el('pairMsg'), pairTable = el('pairTable');
const pairCreate = el('pairCreate'), pairUpsert=el('pairUpsert'), pairDelete = el('pairDelete'), pairRefresh = el('pairRefresh');

pairUse.onclick = ()=>{ pairAuthMsg.textContent="Token set."; };

function parseMap() {
  const t = pairMap.value.trim(); if(!t) return [];
  try { const j = JSON.parse(t); return Array.isArray(j)?j:[]; } catch { throw new Error('Invalid outcome map JSON'); }
}

async function pairsRefresh() {
  try {
    pairMsg.textContent = "Loading…";
    const p = await api('/pairs');
    const rows = p.pairs || [];
    pairTable.innerHTML = '';
    for (const r of rows) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.poly_id}</td>
        <td>${r.myriad_id}</td>
        <td>${r.direction||'same'}</td>
        <td><code>${r.map_json||'[]'}</code></td>
        <td>${r.notes||''}</td>
        <td class="muted">${r.updated_at||''}</td>
        <td><button data-edit="${r.poly_id}|${r.myriad_id}">Edit</button></td>`;
      pairTable.appendChild(tr);
    }
    pairTable.querySelectorAll('button[data-edit]').forEach(btn=>{
      btn.onclick = ()=>{
        const [pid,mid] = btn.getAttribute('data-edit').split('|');
        const r = (p.pairs||[]).find(x=> String(x.poly_id)===pid && String(x.myriad_id)===mid);
        pairPoly.value = r.poly_id; pairMyriad.value = r.myriad_id;
        pairDir.value = r.direction||'same';
        pairMap.value = r.map_json || '[]';
        pairNotes.value = r.notes||'';
        window.scrollTo({top:0,behavior:'smooth'});
      };
    });
    pairMsg.textContent = `${rows.length} pairs`;
  } catch(e) { pairMsg.textContent = e.message; }
}

async function pairCreateFn() {
  try{
    const body = {
      polyId: pairPoly.value.trim(),
      myriadId: pairMyriad.value.trim(),
      direction: pairDir.value,
      map: parseMap(),
      notes: pairNotes.value.trim(),
    };
    if(!body.polyId || !body.myriadId) throw new Error('polyId and myriadId required');
    await api('/admin/pairs', {method:'POST', token: pairTok.value.trim(), body});
    pairMsg.textContent = 'Created.'; pairsRefresh();
  }catch(e){ pairMsg.textContent = e.message; }
}
async function pairUpsertFn() {
  try{
    const polyId = pairPoly.value.trim(), myriadId = pairMyriad.value.trim();
    if(!polyId || !myriadId) throw new Error('polyId and myriadId required');
    await api(`/admin/pairs/${encodeURIComponent(polyId)}/${encodeURIComponent(myriadId)}`, {
      method:'PUT', token: pairTok.value.trim(),
      body: { direction: pairDir.value, map: parseMap(), notes: pairNotes.value.trim() }
    });
    pairMsg.textContent = 'Upserted.'; pairsRefresh();
  }catch(e){ pairMsg.textContent = e.message; }
}
async function pairDeleteFn() {
  try{
    const polyId = pairPoly.value.trim(), myriadId = pairMyriad.value.trim();
    if(!polyId || !myriadId) throw new Error('polyId and myriadId required');
    await api(`/admin/pairs/${encodeURIComponent(polyId)}/${encodeURIComponent(myriadId)}`, {
      method:'DELETE', token: pairTok.value.trim()
    });
    pairMsg.textContent = 'Deleted.'; pairsRefresh();
  }catch(e){ pairMsg.textContent = e.message; }
}

pairCreate.onclick = pairCreateFn;
pairUpsert.onclick = pairUpsertFn;
pairDelete.onclick = pairDeleteFn;
pairRefresh.onclick = pairsRefresh;

// Start
statusEl.textContent = "Press 'Load from DB' or run an ingest.";
pairsRefresh();
</script>
</body>
</html>
